package com.app.service;

import java.util.List;


import javax.transaction.Transactional;

import org.apache.catalina.mapper.Mapper;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.mail.SimpleMailMessage;
import org.springframework.mail.javamail.JavaMailSender;
import org.springframework.stereotype.Service;

import com.app.custom_exceptions.ResourceNotFoundException;
import com.app.dao.DepartmentDao;
import com.app.dao.DoctorDao;
import com.app.dto.DoctorDTO;
import com.app.dto.DoctorRegistrationDTO;
import com.app.pojos.Appointment;
import com.app.pojos.Department;
import com.app.pojos.Doctor;
import com.app.pojos.User;
import com.app.pojos.UserValidity;

@Service
@Transactional
public class DoctorServiceImpl implements DoctorService {
	
	private ModelMapper mapper;
	
	@Autowired
	private DoctorDao doctorDao;
	@Autowired
	private DepartmentDao deptDao;
	
	@Autowired 
	private JavaMailSender javaMailSender;
	
	@Value("${spring.mail.username}")
	private String email;
	
	@Override
	public void addDoctor(DoctorRegistrationDTO d) {
		Department dept = deptDao.findById(d.getDept_id()).orElseThrow(()->new ResourceNotFoundException("no such department"));
		Doctor doctor = mapper.map(d,Doctor.class);
		d.setDept(dept);
		doctorDao.save(d);
	}

	@Override
	public Doctor getDoctorDetails(User u) {
		return doctorDao.findDoctorByUser(u).orElse(null);
	}

	@Override
	public void sendMailToPatient(Appointment a) {
		
		SimpleMailMessage message = new SimpleMailMessage(); 
		String patientmail = a.getPatient().getEmailid();
		
			message.setFrom(email);
	        message.setTo(patientmail); 
	        message.setSubject("Appointment"); 
	        message.setText("Appointment is confirmed");
	        javaMailSender.send(message);
		
	}
	
	@Override
	public String editProfile(DoctorDTO d) {
		Doctor doc=doctorDao.findById(d.getId()).orElse(null);
		doc.setName(d.getName());
		doc.setDob(d.getDob());
		doc.setGender(d.getGender());
		doc.setSpecialization(d.getSpecialization());
		doc.setJoinDate(d.getJoinDate());
		doc.setMobileNo(d.getMobileNo());
		doc.setEmailid(d.getEmailid());
		return "profile updated" ;
	}

	@Override
	public Doctor showDoctorDetails(int id) {
		return doctorDao.findById(id).orElse(null);
	}

	@Override
	public List<Doctor> getDoctorByDept(int id) {
		Department d= deptDao.findById(id).orElse(null);
		
		return doctorDao.findByDept(d);
	}

	@Override
	public List<Doctor> getAllDoctors() {
		return doctorDao.findByUserValidity(UserValidity.ACTIVE);
	}
	
	@Override
	public Doctor findDoctorById(int id) {
		
		return doctorDao.findById(id).orElse(null);

	}
}
	
